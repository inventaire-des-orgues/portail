{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'plugins/leaflet/leaflet.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/leafletcluster/MarkerCluster.Default.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/slider/jquery-ui.css' %}">  
  <link rel="stylesheet" href="{% static 'plugins/leafletgeosearch/geosearch.css' %}">
  <link rel="stylesheet" href="{% static 'plugins/leafletlocate/L.Control.Locate.min.css' %}">
{% endblock %}

{% block content %}
<div id="carte_generale">
  <div class="container-fluid" id="carte">
      <div id="mapid" style="height:700px"></div>
  </div>
  <div id="div_filtre">
    <b class="titre_filtre">Filtrer les orgues</b>
    
    <form id="filtre_formulaire" class="carte_formulaire" action="" >
      <div class="div_carte">
        <label><b>Uniquement les orgues classés monuments historiques : </b><input type="checkbox" name="classes" id="classes"></label>
      </div>

      <div class="div_carte">
        <b>Par nombre de claviers : </b>
        <div >
          <label class="checkbox_claviers"><input type="checkbox" name="clavier" value="I"  checked>I</label>
          <label class="checkbox_claviers"><input type="checkbox" name="clavier" value="II" checked>II</label>
          <label class="checkbox_claviers"><input type="checkbox" name="clavier" value="III" checked>III</label>
          <label class="checkbox_claviers"><input type="checkbox" name="clavier" value="IV" checked>IV</label>
          <label class="checkbox_claviers"><input type="checkbox" name="clavier" value="V" checked>V</label>
          <label class="checkbox_claviers"><input type="checkbox" name="clavier" value="VI" checked>VI</label>
          <label class="checkbox_claviers"><input type="checkbox" name="Pedalier" value="P" checked>P</label>
          <label class="checkbox_claviers"><input type="checkbox" name="clavier_NR" value="non renseigne" checked>Non renseigné</label>
        </div>
      </div>

      <div class="div_carte">
        <b>Par nombre de jeux : </b>
        <div id="slider-range"></div>
        <p id="jeu-range"></p>
      </div>

      <div class="div_carte">
        <b>Par état de fonctionnement : </b>
        <div class="list_checkbox">
          <label><input type="checkbox" name="etat" value="tres_bon" checked>Très bon, tout à fait jouable</label>
          <label><input type="checkbox" name="etat" value="bon" checked>Bon : jouable, défauts mineurs</label>
          <label><input type="checkbox" name="etat" value="altere" checked>Altéré : difficilement jouable</label>
          <label><input type="checkbox" name="etat" value="degrade" checked>Dégradé ou en ruine : injouable</label>
          <label><input type="checkbox" name="etat" value="restauration" checked>En restauration (ou projet initié)</label>
          <label><input type="checkbox" name="etat_NR" value="non renseigne" checked>Non renseigné</label>
        </div>
      </div>

      <div class="div_carte">
        <b>Par facteur d'orgue : </b>
        <select type="text" id="facteur_pk" placeholder="Choisir un facteur"></select>
        <label><input type="checkbox" name="construction" id="construction">N'afficher que les orgues pour lesquels le facteur a participé à la construction ou à la reconstruction.</label>
      </div>
      </form>

    <b class="titre_filtre">Les manufactures d'orgues</b>
    <form id="chercher_facteur" class="carte_formulaire" action="">
      <div class="div_carte">
        <b>Rechercher une manufacture d'orgues :</b>
        <select type="text" id="nom_facteur_recherche" placeholder="Choisir un facteur"></select>
      </div>
    </form>
    <label><input type="checkbox" name="manufacture" id="manufacture" style="margin-left: 15px;">Afficher toutes les manufactures d'orgues.</label>
  </div>
</div>

{% endblock %}

{% block js_extra %}
  <script src="{% static 'plugins/leaflet/leaflet.js' %}"></script>
  <script src="{% static 'plugins//leafletcluster/leaflet.markercluster.js' %}"></script>
  <script src="{% static 'plugins/slider/jquery-ui.js' %}"></script>
  <script src="{% static 'plugins/leafletcluster/leaflet.markercluster.js' %}"></script>
  <script src="{% static 'plugins/leafletgeosearch/geosearch.js' %}"></script>
  <script src="{% static 'plugins/leafletlocate/L.Control.Locate.min.js' %}"></script>
  <script>
    var carte_orgues = L.map('mapid',
        {
          scrollWheelZoom: true,
        }).setView([46.2, 2.2], 5);

    var mapboxAccessToken =
        "pk.eyJ1IjoiaW52ZW50YWlyZWRlc29yZ3VlcyIsImEiOiJja243Y3huZWcwbXJjMndvNmU0dnhnM2ZpIn0.vUjgVVyXZFYNEl1xQ3pLww";

    L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=" +
    mapboxAccessToken,
    {
      id: "mapbox/light-v9",
      attribution: "",
      tileSize: 512,
      zoomOffset: -1
    }
    ).addTo(carte_orgues);

    const search = new GeoSearch.GeoSearchControl({
      style: 'bar',
      searchLabel: 'Rechercher par adresse',
      autoComplete: true, // optional: true|false  - default true
      autoCompleteDelay: 150,
      zoomLevel: 12,
      resultFormat: ({ result }) => '<b>' + result.label + '</b><br/><i>' + result.raw.properties.context + '</i>',
      provider: new GeoSearch.GeoApiFrProvider({
        params: {
          type: 'municipality',
          autocomplete: 1,
        }
      }),
    });
    console.log(search);
    carte_orgues.addControl(search);
    L.control.locate({
      showPopup: false,
      drawCircle: false,
      initialZoomLevel: 10,
    }).addTo(carte_orgues);

    var mh_icon = L.icon({
      iconUrl: '{% static 'img/mh_icon.png' %}',
      shadowUrl: '{% static 'img/marker-shadow.png' %}',

      iconSize: [25, 41], // size of the icon
      shadowSize: [41, 41], // size of the shadow
      iconAnchor: [12, 41], // point of the icon which will correspond to marker's location
      shadowAnchor: [12, 41],  // the same for the shadow
      {#popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor#}
    });

    var nonmh_icon = L.icon({
      iconUrl: '{% static 'img/nonmh_icon.png' %}',
      shadowUrl: '{% static 'img/marker-shadow.png' %}',

      iconSize: [25, 41], // size of the icon
      shadowSize: [41, 41], // size of the shadow
      iconAnchor: [12, 41], // point of the icon which will correspond to marker's location
      shadowAnchor: [12, 41],  // the same for the shadow
      {#popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor#}
    });

    var facteur_icon = L.icon({
      iconUrl: '{% static 'img/icone_facteur_carte.png' %}',

      iconSize: [25, 25], // size of the icon
      iconAnchor: [3, 35], // point of the icon which will correspond to marker's location
      {#popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor#}
    });

    var markersCluster = new L.MarkerClusterGroup({
      iconCreateFunction: function (cluster) {
        return L.divIcon({
          html: cluster.getChildCount(),
          className: 'mycluster',
          iconSize: null
        });
      }
    });

    var markersClusterFacteur = new L.MarkerClusterGroup({
      iconCreateFunction: function (cluster) {
        return L.divIcon({
          html: cluster.getChildCount(),
          className: 'myclusterfacteur',
          iconSize: null
        });
      }
    });

    var liste_orgues;
    var min_jeux;
    var max_jeux;
    var composition_filter;
    var etat_filter;
    var orgues_ajoutes;

    $.getJSON("{% url 'orgues:orgue-list-js' %}", function (orgues) {//Affiche les orgues à l'ouverture de la page.
    orgues_ajoutes = [];
    liste_orgues = orgues;
    orgues_affiches = [];
    orgues.forEach(orgue => {
      if (! orgues_ajoutes.includes(orgue.slug)) {
        orgues_affiches.push(orgue);
        orgues_ajoutes.push(orgue.slug);
      }
    });      
    afficher_orgue(orgues_affiches);
    });

    $('#filtre_formulaire').change(function(){
      // Lorsqu'un élément du formulaire change, récupère les valeurs des deux sliders et effectue la requête
      min_jeux = $( "#slider-range" ).slider( "values", 0 );
      max_jeux = $( "#slider-range" ).slider( "values", 1 );
      requete();
    })

    function check_organ(orgue){
      //Renvoie un booléen indiquant si l'orgue satisfait les critères requis définis dans le filtre
      //Si l'orgue a déjà été ajouté, on ne l'ajoute pas (chaque orgue apparaît autant de fois qu'un facteur d'orgues lui a été associé)
      if (orgues_ajoutes.includes(orgue.slug)) {
        return false;
      }

      //Sélection des orgues classés
      if ($('#classes').is(':checked') && orgue.references_palissy === null) {
        return false;        
      }

      //Sélection des orgues par le nombre de jeux
      if (orgue.nombre_jeux < min_jeux || orgue.nombre_jeux > max_jeux) {
        return false;
      }

      //Sélection des orgues par leur composition
      if (orgue.resume_composition !== null) {
        var resume = orgue.resume_composition.split(" ")[1];
        if (! composition_filter.includes(resume)) {
          return false;          
        }
      }
      else{
        if (! $("input[name='clavier_NR']").is(':checked')) {
          return false;
        }
      }
    
      //Sélection des orgues par leur état
      if (orgue.etat === null) {
        if (! $("input[name='etat_NR']").is(':checked')) {
          return false;          
        }
      }
      else{
        if (! etat_filter.includes(orgue.etat)) {
          return false;
        }
      }

      //Sélection des orgues par facteur
      facteur = $("#facteur_pk").val()
      if (facteur != -1 && facteur!==null) {
        if (orgue.evenements__facteurs__pk != facteur) {
          return false;
        }
        else{
          if ($("input[name='construction']").is(':checked')) {
            if (orgue.evenements__type != "construction" && orgue.evenements__type != "reconstruction") {
              return false;              
            }
          }
        }
      }
      orgues_ajoutes.push(orgue.slug);
      return true;
    }

    function write_etat(){
      //Crée une liste contenant tous les états autorisés définis dans le filtre
      etat_filter = [];
      $('input[name="etat"]:checked').each(function() { 
        etat_filter.push($(this).val());
      });     
    }

    function write_composition(){
      //Crée une liste contenant toutes les composiitons autorisées définies dans le filtre
      composition_filter = [];
      $('input[name="clavier"]:checked').each(function() { 
        composition_filter.push($(this).val());
        if ($("input[name='Pedalier']").is(':checked')) {
          composition_filter.push($(this).val()+"/P");
        }
      });
    }
    
    function requete() {
      // Effectue la requête
      markersCluster.clearLayers();
      write_composition();
      write_etat();
      orgues_ajoutes = [];
      orgues_affiches = liste_orgues.filter(check_organ);
      afficher_orgue(orgues_affiches);
    }

    $( "#slider-range" ).slider({
      //Slider qui permet la sélection du nombre de jeux
      range: true,
      min: 0,
      max: 130,
      values: [ 0, 130 ],
      slide: function( event, ui ) {
        $( "#jeu-range" ).html("Nombre de jeux : " + ui.values[ 0 ] + " - " + ui.values[ 1 ] );
        min_jeux = ui.values[ 0 ];
        max_jeux = ui.values[ 1 ];
        requete();
      }
    });

    $( "#jeu-range" ).html( 
      "Nombre de jeux : " + $( "#slider-range" ).slider( "values", 0 ) + " - " +  $( "#slider-range" ).slider( "values", 1 ) 
    )

    $('#manufacture').change(function(){
      //Affiche ou cache les manufactures d'orgues en fonction de l'état du bouton.
      if ($('#manufacture').is(':checked')){
        afficher_manufactures();
      }
      else{
        markersClusterFacteur.clearLayers();
      }
    })

    $("#facteur_pk").select2({
      //Liste des facteurs proposés dans le champ "Filtrer les orgues par facteur"
      ajax: {
        url: '{% url 'orgues:facteur-list-js' %}',
        data: function (params) {
          var query = {
            search: params.term,
            page: params.page || 1
          }
          return query;
        }
      },
      placeholder: {
        id: '-1',
        text: 'Tous les facteurs'
      },
      escapeMarkup: function (markup) {
        return markup;
      },
      language: {
          noResults: function () {
            return "Aucun facteur trouvé ... contactez-nous si vous souhaitez ajouter un nouveau facteur.";
          }
      },
      width: '100%'
    });

    $("#nom_facteur_recherche").select2({
      //Liste des facteurs proposés dans le champ "Rechercher une manufacture d'orgues"
      ajax: {
        url: '{% url 'orgues:facteur-list-js-lonlat' %}',
        data: function (params) {
          var query = {
            search: params.term,
            page: params.page || 1
          }
          return query;
        }
      },
      escapeMarkup: function (markup) {
        return markup;
      },
      language: {
          noResults: function () {
            return "Aucun facteur trouvé ... contactez-nous si vous souhaitez ajouter un nouveau facteur.";
          }
      },
      width: '100%'
    });

    $("#nom_facteur_recherche").change(function(e){
      //Affiche les manufactures d'orgues et centre la carte sur celle choisie
      e.preventDefault();
      markersClusterFacteur.clearLayers();
      document.getElementById("manufacture").checked = true;
      afficher_manufactures();
      data_filtre = {"facteur": $("#nom_facteur_recherche").val(), "type":"tout_type"}
      $.ajax({
        type: "GET",
        url: "{% url 'orgues:facteur-js-lonlat' %}",
        data: data_filtre,
        success: function (data) {
          carte_orgues.setView([data[0].latitude_atelier, data[0].longitude_atelier], 10);
        },
        error: function () {
        }
      })
    })


    function afficher_orgue(orgues){
      //Affiche les orgues contenus dans la liste donnée en argument
      for (var i = 0; i < orgues.length; i++) {
        var popup = '<p> <b>' + orgues[i].commune + '</b>' + '</br>' + orgues[i].edifice + '</br><a href="/detail/' + orgues[i].slug + '">Voir l\'orgue</a></p>';
        var ttip = '<b>' + orgues[i].commune + '</b>' + '</br>' + orgues[i].edifice;
        var latLng = new L.LatLng(orgues[i].latitude, orgues[i].longitude);
        if (orgues[i].references_palissy) {
          var marker = new L.marker(latLng, {icon: mh_icon}).bindPopup(popup);
        }
        else {
          var marker = new L.Marker(latLng, {icon:nonmh_icon}).bindPopup(popup);
        }
        marker.bindTooltip(ttip);
        markersCluster.addLayer(marker);
        }
        carte_orgues.addLayer(markersCluster);
    }

    function afficher_manufactures(){
      //Affiche les manufactures d'orgues
      $.getJSON("{% url 'orgues:facteur-list-js-leaflet' %}", function (facteurs) {
          for (var i = 0; i < facteurs.length; i++) {
            var popup = '<p> <b>' + facteurs[i].nom + '</p> </b>';
            var latLng = new L.LatLng(facteurs[i].latitude_atelier, facteurs[i].longitude_atelier);
            var marker = new L.Marker(latLng, {icon:facteur_icon}).bindPopup(popup);
            markersClusterFacteur.addLayer(marker);
          }
          carte_orgues.addLayer(markersClusterFacteur);
        });
    }
  </script>

{% endblock %}
